apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-productivity
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  labels:
    app.kubernetes.io/name: pg-productivity
    app.kubernetes.io/part-of: postgres
spec:
  description: "Shared PostgreSQL cluster for productivity apps."

  imageName: ghcr.io/cloudnative-pg/postgresql:18.1
  instances: 3
  primaryUpdateStrategy: unsupervised

  storage:
    storageClass: ceph-block
    size: 50Gi
  walStorage:
    storageClass: ceph-block
    size: 10Gi

  backup:
    barmanObjectStore:
      destinationPath: s3://cluster-backups/cnpg/pg-productivity
      endpointURL: http://minio-api.other.svc.cluster.local:9000
      s3Credentials:
        accessKeyId:
          name: pg-productivity-backup-s3-creds
          key: AWS_ACCESS_KEY_ID
        secretAccessKey:
          name: pg-productivity-backup-s3-creds
          key: AWS_SECRET_ACCESS_KEY
      data:
        compression: gzip
        jobs: 2
      wal:
        compression: gzip
        maxParallel: 4
    retentionPolicy: "30d"
    target: prefer-standby

  enableSuperuserAccess: true

  postgresql:
    parameters:
      max_connections: "200"
      log_min_duration_statement: "500ms"
    synchronous:
      method: any
      number: 1
      dataDurability: preferred
