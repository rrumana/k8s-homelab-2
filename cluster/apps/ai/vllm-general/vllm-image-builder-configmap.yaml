apiVersion: v1
kind: ConfigMap
metadata:
  name: vllm-image-builder-scripts
data:
  build-nightly.sh: |
    #!/bin/sh
    set -eu

    install_deps_if_possible() {
      if [ "$#" -eq 0 ]; then
        return 0
      fi
      if command -v microdnf >/dev/null 2>&1; then
        microdnf install -y "$@" >/dev/null
        return 0
      fi
      if command -v dnf >/dev/null 2>&1; then
        dnf install -y "$@" >/dev/null
        return 0
      fi
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache "$@" >/dev/null
        return 0
      fi
      if command -v apt-get >/dev/null 2>&1; then
        apt-get update >/dev/null
        apt-get install -y "$@" >/dev/null
        return 0
      fi
      return 1
    }

    log() {
      printf '[%s] %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$*"
    }

    require_cmd() {
      if ! command -v "$1" >/dev/null 2>&1; then
        log "Missing required command: $1"
        exit 1
      fi
    }

    require_cmd buildah
    if ! command -v skopeo >/dev/null 2>&1; then
      log "Installing missing runtime dependency (skopeo)"
      install_deps_if_possible skopeo || {
        log "Could not install skopeo automatically; ensure image contains skopeo"
        exit 1
      }
    fi
    require_cmd skopeo

    : "${GHCR_USER:?GHCR_USER is required}"
    : "${GHCR_TOKEN:?GHCR_TOKEN is required}"

    UPSTREAM_IMAGE="${UPSTREAM_IMAGE:-docker://docker.io/rocm/vllm-dev:nightly}"
    TARGET_REPO="${TARGET_REPO:-ghcr.io/${GHCR_USER}/vllm-openai-rocm-gfx1150}"
    TRACK_TAG="${TRACK_TAG:-nightly-gfx1150}"
    VLLM_REF="${VLLM_REF:-main}"
    ROCM_ARCH="${ROCM_ARCH:-gfx1150}"
    STORAGE_DRIVER="${STORAGE_DRIVER:-overlay}"
    HARD_RESET_STORAGE_ON_START="${HARD_RESET_STORAGE_ON_START:-1}"
    FORCE_BUILD="${FORCE_BUILD:-0}"
    BUILDER_REVISION="${BUILDER_REVISION:-2026-02-19-1}"

    hard_reset_storage() {
      log "Hard-resetting Buildah storage directory"
      buildah rm --all --storage-driver "${STORAGE_DRIVER}" >/dev/null 2>&1 || true
      buildah rmi --all --storage-driver "${STORAGE_DRIVER}" >/dev/null 2>&1 || true
      buildah prune -af --storage-driver "${STORAGE_DRIVER}" >/dev/null 2>&1 || true
      rm -rf /var/lib/containers/storage/* /var/lib/containers/cache/* /var/lib/containers/tmp/* >/dev/null 2>&1 || true
    }

    ensure_rocm_requirements_compat() {
      root_req_dir="/workspace/vllm/requirements"
      pkg_req_dir="/workspace/vllm/vllm/requirements"
      root_rocm_req="${root_req_dir}/rocm.txt"
      pkg_rocm_req="${pkg_req_dir}/rocm.txt"

      if [ -f "${root_rocm_req}" ] || [ -f "${pkg_rocm_req}" ]; then
        mkdir -p "${root_req_dir}" "${pkg_req_dir}"
        [ -f "${root_rocm_req}" ] || cp "${pkg_rocm_req}" "${root_rocm_req}" || true
        [ -f "${pkg_rocm_req}" ] || cp "${root_rocm_req}" "${pkg_rocm_req}" || true
        log "requirements/rocm.txt already present in repository layout"
        return 0
      fi

      log "requirements/rocm.txt not found; creating compatibility shims"
      mkdir -p "${root_req_dir}" "${pkg_req_dir}"
      for candidate in \
        "${root_req_dir}/rocm-dev.txt" \
        "${root_req_dir}/rocm_dev.txt" \
        "${root_req_dir}/rocm-requirements.txt" \
        "${root_req_dir}/build.txt" \
        "${root_req_dir}/common.txt" \
        "${root_req_dir}/cuda.txt" \
        "${pkg_req_dir}/rocm-dev.txt" \
        "${pkg_req_dir}/rocm_dev.txt" \
        "${pkg_req_dir}/rocm-requirements.txt" \
        "${pkg_req_dir}/build.txt" \
        "${pkg_req_dir}/common.txt" \
        "${pkg_req_dir}/cuda.txt"
      do
        if [ -f "${candidate}" ]; then
          cp "${candidate}" "${root_rocm_req}"
          cp "${candidate}" "${pkg_rocm_req}"
          log "Created compatibility rocm.txt from $(basename "${candidate}")"
          return 0
        fi
      done

      : > "${root_rocm_req}"
      cp "${root_rocm_req}" "${pkg_rocm_req}"
      log "No compatible requirements file found; created empty rocm.txt shims"
    }

    patch_dockerfile_rocm_requirements() {
      dockerfile="/workspace/vllm/docker/Dockerfile.rocm"
      if [ ! -f "${dockerfile}" ]; then
        log "Dockerfile not found at ${dockerfile}"
        exit 1
      fi

      log "Patching Dockerfile.rocm to support fallback requirements paths"
      sed -i \
        "s|python3 -m pip install -r requirements/rocm.txt|python3 -m pip install -r requirements/rocm.txt || python3 -m pip install -r requirements/build.txt || python3 -m pip install -r requirements/common.txt || python3 -m pip install -r vllm/requirements/rocm.txt || python3 -m pip install -r vllm/requirements/build.txt || python3 -m pip install -r vllm/requirements/common.txt|g" \
        "${dockerfile}"
      log "Patched Dockerfile command(s):"
      grep -n "python3 -m pip install -r" "${dockerfile}" | head -n 5 || true
    }

    upstream_digest="$(skopeo inspect --format '{{.Digest}}' "${UPSTREAM_IMAGE}")"
    current_digest="$(skopeo inspect --format '{{ index .Labels "io.rrumana.vllm.upstream.digest" }}' "docker://${TARGET_REPO}:${TRACK_TAG}" 2>/dev/null || true)"
    current_builder_revision="$(skopeo inspect --format '{{ index .Labels "io.rrumana.vllm.builder.revision" }}' "docker://${TARGET_REPO}:${TRACK_TAG}" 2>/dev/null || true)"

    if [ "${FORCE_BUILD}" = "1" ]; then
      log "FORCE_BUILD=1 set. Ignoring digest short-circuit."
    elif [ -n "${current_digest}" ] && [ "${current_digest}" = "${upstream_digest}" ] && [ "${current_builder_revision}" = "${BUILDER_REVISION}" ]; then
      log "No upstream digest change (${upstream_digest}). Skipping build."
      exit 0
    elif [ -n "${current_digest}" ] && [ "${current_digest}" = "${upstream_digest}" ]; then
      log "Upstream digest unchanged but builder revision differs (${current_builder_revision} -> ${BUILDER_REVISION}); rebuilding."
    fi

    digest_short="$(printf '%s' "${upstream_digest#sha256:}" | cut -c1-12)"
    version_tag="${TRACK_TAG}-${digest_short}"

    log "Upstream digest changed to ${upstream_digest}"
    log "Building ${TARGET_REPO}:${version_tag}"

    log "Disk usage before cleanup:"
    df -h /var/lib/containers || true
    if [ "${HARD_RESET_STORAGE_ON_START}" = "1" ]; then
      hard_reset_storage
    fi
    buildah prune -af --storage-driver "${STORAGE_DRIVER}" || true
    log "Disk usage after pre-build prune:"
    df -h /var/lib/containers || true

    if ! command -v git >/dev/null 2>&1; then
      log "Installing missing runtime dependency (git)"
      install_deps_if_possible git || {
        log "Could not install git automatically; ensure image contains git"
        exit 1
      }
    fi
    require_cmd git

    rm -rf /workspace/vllm
    git clone --depth 1 --branch "${VLLM_REF}" https://github.com/vllm-project/vllm.git /workspace/vllm
    ensure_rocm_requirements_compat
    patch_dockerfile_rocm_requirements
    log "Compatibility requirement files:"
    find /workspace/vllm -type f -path '*/requirements/rocm.txt' -print || true

    printf '%s' "${GHCR_TOKEN}" | buildah login --username "${GHCR_USER}" --password-stdin ghcr.io

    buildah bud \
      --storage-driver "${STORAGE_DRIVER}" \
      --build-arg "ARG_PYTORCH_ROCM_ARCH=${ROCM_ARCH}" \
      --build-arg "BASE_IMAGE=docker.io/rocm/vllm-dev:nightly" \
      --label "io.rrumana.vllm.rocm.arch=${ROCM_ARCH}" \
      --label "io.rrumana.vllm.upstream.base=docker.io/rocm/vllm-dev:nightly" \
      --label "io.rrumana.vllm.upstream.digest=${upstream_digest}" \
      --label "io.rrumana.vllm.builder.revision=${BUILDER_REVISION}" \
      -f /workspace/vllm/docker/Dockerfile.rocm \
      -t "${TARGET_REPO}:${version_tag}" \
      /workspace/vllm

    buildah tag --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}" "${TARGET_REPO}:${TRACK_TAG}"

    buildah push --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}"
    buildah push --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${TRACK_TAG}"

    buildah rmi --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}" "${TARGET_REPO}:${TRACK_TAG}" || true
    buildah prune -af --storage-driver "${STORAGE_DRIVER}" || true
    log "Disk usage after build cleanup:"
    df -h /var/lib/containers || true

    log "Build and push complete: ${TARGET_REPO}:${version_tag} and :${TRACK_TAG}"
