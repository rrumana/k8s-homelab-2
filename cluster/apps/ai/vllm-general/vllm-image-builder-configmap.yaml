apiVersion: v1
kind: ConfigMap
metadata:
  name: vllm-image-builder-scripts
data:
  build-nightly.sh: |
    #!/bin/sh
    set -eu

    install_deps_if_possible() {
      if command -v microdnf >/dev/null 2>&1; then
        microdnf install -y git skopeo >/dev/null
        return 0
      fi
      if command -v dnf >/dev/null 2>&1; then
        dnf install -y git skopeo >/dev/null
        return 0
      fi
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache git skopeo >/dev/null
        return 0
      fi
      if command -v apt-get >/dev/null 2>&1; then
        apt-get update >/dev/null
        apt-get install -y git skopeo >/dev/null
        return 0
      fi
      return 1
    }

    log() {
      printf '[%s] %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$*"
    }

    require_cmd() {
      if ! command -v "$1" >/dev/null 2>&1; then
        log "Missing required command: $1"
        exit 1
      fi
    }

    require_cmd buildah
    if ! command -v skopeo >/dev/null 2>&1 || ! command -v git >/dev/null 2>&1; then
      log "Installing missing runtime dependencies (git/skopeo)"
      install_deps_if_possible || {
        log "Could not install dependencies automatically; ensure image contains git and skopeo"
        exit 1
      }
    fi
    require_cmd skopeo
    require_cmd git

    : "${GHCR_USER:?GHCR_USER is required}"
    : "${GHCR_TOKEN:?GHCR_TOKEN is required}"

    UPSTREAM_IMAGE="${UPSTREAM_IMAGE:-docker://docker.io/rocm/vllm-dev:nightly}"
    TARGET_REPO="${TARGET_REPO:-ghcr.io/${GHCR_USER}/vllm-openai-rocm-gfx1150}"
    TRACK_TAG="${TRACK_TAG:-nightly-gfx1150}"
    VLLM_REF="${VLLM_REF:-main}"
    ROCM_ARCH="${ROCM_ARCH:-gfx1150}"
    STORAGE_DRIVER="${STORAGE_DRIVER:-overlay}"

    upstream_digest="$(skopeo inspect --format '{{.Digest}}' "${UPSTREAM_IMAGE}")"
    current_digest="$(skopeo inspect --format '{{ index .Labels "io.rrumana.vllm.upstream.digest" }}' "docker://${TARGET_REPO}:${TRACK_TAG}" 2>/dev/null || true)"

    if [ -n "${current_digest}" ] && [ "${current_digest}" = "${upstream_digest}" ]; then
      log "No upstream digest change (${upstream_digest}). Skipping build."
      exit 0
    fi

    digest_short="$(printf '%s' "${upstream_digest#sha256:}" | cut -c1-12)"
    version_tag="${TRACK_TAG}-${digest_short}"

    log "Upstream digest changed to ${upstream_digest}"
    log "Building ${TARGET_REPO}:${version_tag}"

    log "Disk usage before cleanup:"
    df -h /var/lib/containers || true
    buildah prune -af --storage-driver "${STORAGE_DRIVER}" || true
    log "Disk usage after pre-build prune:"
    df -h /var/lib/containers || true

    rm -rf /workspace/vllm
    git clone --depth 1 --branch "${VLLM_REF}" https://github.com/vllm-project/vllm.git /workspace/vllm

    printf '%s' "${GHCR_TOKEN}" | buildah login --username "${GHCR_USER}" --password-stdin ghcr.io

    buildah bud \
      --storage-driver "${STORAGE_DRIVER}" \
      --build-arg "ARG_PYTORCH_ROCM_ARCH=${ROCM_ARCH}" \
      --build-arg "BASE_IMAGE=docker.io/rocm/vllm-dev:nightly" \
      --label "io.rrumana.vllm.rocm.arch=${ROCM_ARCH}" \
      --label "io.rrumana.vllm.upstream.base=docker.io/rocm/vllm-dev:nightly" \
      --label "io.rrumana.vllm.upstream.digest=${upstream_digest}" \
      -f /workspace/vllm/docker/Dockerfile.rocm \
      -t "${TARGET_REPO}:${version_tag}" \
      /workspace/vllm

    buildah tag --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}" "${TARGET_REPO}:${TRACK_TAG}"

    buildah push --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}"
    buildah push --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${TRACK_TAG}"

    buildah rmi --storage-driver "${STORAGE_DRIVER}" "${TARGET_REPO}:${version_tag}" "${TARGET_REPO}:${TRACK_TAG}" || true
    buildah prune -af --storage-driver "${STORAGE_DRIVER}" || true
    log "Disk usage after build cleanup:"
    df -h /var/lib/containers || true

    log "Build and push complete: ${TARGET_REPO}:${version_tag} and :${TRACK_TAG}"
